<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - DroneDelivery</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    
    <nav class="navbar">
        <div class="container">
            <div class="nav-wrapper">
                <a href="index.html" class="logo" style="text-decoration: none; color: inherit;">
                    <span class="logo-icon">üöÅ</span>
                    <span class="logo-text">DroneDelivery</span>
                </a>
                <ul class="nav-menu">
                    <li><a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li><a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a></li>
                    <li><a href="profile.html">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
                    <li><a href="index.html#contact">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                </ul>
                <button id="logoutBtn" class="btn-secondary">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </nav>

    
    <section class="profile-section">
        <div class="container">
            <div class="profile-header">
                <h1 class="profile-title">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
            </div>

            <div class="profile-content">
                <div class="profile-tabs">
                    <button class="tab-btn active" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</button>
                    <button class="tab-btn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    <button class="tab-btn" data-tab="orders">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</button>
                </div>

                
                <div class="tab-content active" id="profile-tab">
                    <div class="profile-card">
                        <h2 class="card-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h2>
                        <div id="profileLoading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                        <div class="profile-info" id="profileInfo" style="display: none;">
                            <div class="info-row">
                                <span class="info-label">–ò–º—è:</span>
                                <span class="info-value" id="profile-name">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value" id="profile-email">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                <span class="info-value" id="profile-phone">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">–ì–æ—Ä–æ–¥:</span>
                                <span class="info-value" id="profile-city">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</span>
                                <span class="info-value" id="profile-address">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</span>
                                <span class="info-value" id="profile-created">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                
                <div class="tab-content" id="settings-tab">
                    <div class="profile-card">
                        <h2 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                        <form id="settingsForm" class="settings-form">
                            <div class="form-group">
                                <label for="settings_full_name">–ü–æ–ª–Ω–æ–µ –∏–º—è *</label>
                                <input type="text" id="settings_full_name" name="full_name" required>
                            </div>

                            <div class="form-group">
                                <label for="settings_phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                                <input type="tel" id="settings_phone" name="phone" required>
                            </div>

                            <div class="form-group">
                                <label for="settings_city">–ì–æ—Ä–æ–¥</label>
                                <input type="text" id="settings_city" name="default_delivery_city" placeholder="–ú–æ—Å–∫–≤–∞">
                            </div>

                            <div class="form-group">
                                <label for="settings_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
                                <input type="text" id="settings_address" name="default_delivery_address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1, –∫–≤. 10">
                            </div>

                            <div class="form-group">
                                <label for="settings_password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å)</label>
                                <input type="password" id="settings_password" name="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6">
                            </div>

                            <div id="settingsError" class="error-message" style="display: none;"></div>
                            <div id="settingsSuccess" class="success-message" style="display: none;"></div>

                            <button type="submit" class="btn-primary btn-large">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        </form>
                    </div>
                </div>

                
                <div class="tab-content" id="orders-tab">
                    <div class="profile-card">
                        <h2 class="card-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
                        <div id="ordersList" class="orders-list">
                            <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo">
                        <span class="logo-icon">üöÅ</span>
                        <span class="logo-text">DroneDelivery</span>
                    </div>
                    <p class="footer-description">
                        –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ –¥—Ä–æ–Ω–∞–º–∏ –ø–æ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–µ. 
                        –ë—ã—Å—Ç—Ä–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ, —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ.
                    </p>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">–£—Å–ª—É–≥–∏</h4>
                    <ul class="footer-links">
                        <li><a href="catalog.html">–ï–¥–∞</a></li>
                        <li><a href="catalog.html">–õ–µ–∫–∞—Ä—Å—Ç–≤–∞</a></li>
                        <li><a href="catalog.html">–ü–æ—Å—ã–ª–∫–∏</a></li>
                        <li><a href="catalog.html">–¢–µ—Ö–Ω–∏–∫–∞</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">–ö–æ–º–ø–∞–Ω–∏—è</h4>
                    <ul class="footer-links">
                        <li><a href="index.html#about">–û –Ω–∞—Å</a></li>
                        <li><a href="index.html#how-it-works">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</a></li>
                        <li><a href="index.html#contact">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                        <li><a href="#">–ö–∞—Ä—å–µ—Ä–∞</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4 class="footer-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h4>
                    <ul class="footer-links">
                        <li><a href="#">–ü–æ–º–æ—â—å</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">–£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a></li>
                        <li><a href="#">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 DroneDelivery. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
                <div class="footer-social">
                    <a href="#" class="social-link">üìò</a>
                    <a href="#" class="social-link">üì∑</a>
                    <a href="#" class="social-link">üê¶</a>
                    <a href="#" class="social-link">üíº</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const API_URL = 'http://localhost:8000';

        const token = localStorage.getItem('access_token');
        if (!token) {
            alert('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
            window.location.href = 'login.html';
        }

        async function loadUserData() {
            const loadingEl = document.getElementById('profileLoading');
            const infoEl = document.getElementById('profileInfo');
            
            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                }

                const user = await response.json();
                
                document.getElementById('profile-name').textContent = user.full_name || '-';
                document.getElementById('profile-email').textContent = user.email || '-';
                document.getElementById('profile-phone').textContent = user.phone || '-';
                document.getElementById('profile-city').textContent = user.default_delivery_city || '–ù–µ —É–∫–∞–∑–∞–Ω';
                document.getElementById('profile-address').textContent = user.default_delivery_address || '–ù–µ —É–∫–∞–∑–∞–Ω';
                
                if (user.created_at) {
                    const date = new Date(user.created_at);
                    document.getElementById('profile-created').textContent = date.toLocaleDateString('ru-RU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                document.getElementById('settings_full_name').value = user.full_name || '';
                document.getElementById('settings_phone').value = user.phone || '';
                document.getElementById('settings_city').value = user.default_delivery_city || '';
                document.getElementById('settings_address').value = user.default_delivery_address || '';

                loadingEl.style.display = 'none';
                infoEl.style.display = 'block';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                loadingEl.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
            }
        }

        async function loadOrders() {
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>';
            
            try {
                const response = await fetch(`${API_URL}/orders/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    window.location.href = 'login.html';
                    return;
                }

                if (response.ok) {
                    const orders = await response.json();
                    
                    if (orders.length === 0) {
                        ordersList.innerHTML = '<p class="no-orders">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤. <a href="catalog.html">–°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑!</a></p>';
                    } else {
                        ordersList.innerHTML = orders.map(order => `
                            <div class="order-item">
                                <div class="order-header">
                                    <span class="order-id">–ó–∞–∫–∞–∑ #${order.id}</span>
                                    <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                                </div>
                                <div class="order-body">
                                    <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${getCategoryText(order.category)}</p>
                                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${order.description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${order.delivery_address}</p>
                                    <p><strong>–í—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> ${getDeliveryTimeText(order.delivery_time)}</p>
                                    ${order.weight ? `<p><strong>–í–µ—Å:</strong> ${order.weight} –∫–≥</p>` : ''}
                                    <p><strong>–¶–µ–Ω–∞:</strong> ${order.price} ‚ÇΩ</p>
                                    <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${new Date(order.created_at).toLocaleString('ru-RU')}</p>
                                    ${order.comment ? `<p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.comment}</p>` : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    let errorText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤';
                    try {
                        const errorData = await response.json();
                        if (errorData.detail) {
                            errorText = errorData.detail;
                        }
                    } catch (e) {
                        errorText = `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                    }
                    ordersList.innerHTML = `<p class="no-orders">${errorText}</p>`;
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤:', error);
                ordersList.innerHTML = '<p class="no-orders">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—â–µ–Ω.</p>';
            }
        }

        function getStatusText(status) {
            const statuses = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω',
                'in_delivery': '–í –ø—É—Ç–∏',
                'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω',
                'cancelled': '–û—Ç–º–µ–Ω–µ–Ω'
            };
            return statuses[status] || status;
        }

        function getCategoryText(category) {
            const categories = {
                'food': '–ï–¥–∞',
                'medicine': '–õ–µ–∫–∞—Ä—Å—Ç–≤–∞',
                'parcels': '–ü–æ—Å—ã–ª–∫–∏',
                'tech': '–¢–µ—Ö–Ω–∏–∫–∞',
                'gifts': '–ü–æ–¥–∞—Ä–∫–∏',
                'documents': '–î–æ–∫—É–º–µ–Ω—Ç—ã'
            };
            return categories[category] || category;
        }

        function getDeliveryTimeText(time) {
            const times = {
                'asap': '–ö–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ',
                '30min': '–í —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω—É—Ç',
                '1hour': '–í —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞',
                '2hours': '–í —Ç–µ—á–µ–Ω–∏–µ 2 —á–∞—Å–æ–≤'
            };
            return times[time] || time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        }

        let ordersUpdateInterval = null;

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');

                if (tabName === 'orders') {
                    loadOrders();
                    if (ordersUpdateInterval) {
                        clearInterval(ordersUpdateInterval);
                    }
                    ordersUpdateInterval = setInterval(loadOrders, 5000);
                } else {
                    if (ordersUpdateInterval) {
                        clearInterval(ordersUpdateInterval);
                        ordersUpdateInterval = null;
                    }
                }
            });
        });

        document.getElementById('settingsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const errorMsg = document.getElementById('settingsError');
            const successMsg = document.getElementById('settingsSuccess');
            const submitBtn = this.querySelector('button[type="submit"]');
            
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

            const formData = {
                full_name: document.getElementById('settings_full_name').value,
                phone: document.getElementById('settings_phone').value,
                default_delivery_city: document.getElementById('settings_city').value || null,
                default_delivery_address: document.getElementById('settings_address').value || null
            };

            const password = document.getElementById('settings_password').value;
            if (password) {
                if (password.length < 6) {
                    errorMsg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                    errorMsg.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                    return;
                }
                formData.password = password;
            }

            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    successMsg.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                    successMsg.style.display = 'block';
                    loadUserData();
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                } else {
                    const data = await response.json();
                    errorMsg.textContent = data.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
                    errorMsg.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                errorMsg.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                errorMsg.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                localStorage.removeItem('access_token');
                window.location.href = 'index.html';
            }
        });

        loadUserData();

        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        if (tabParam === 'orders') {
            setTimeout(() => {
                const ordersTabBtn = document.querySelector('.tab-btn[data-tab="orders"]');
                if (ordersTabBtn) {
                    ordersTabBtn.click();
                }
            }, 100);
        }

        window.addEventListener('scroll', function() {
            const navbar = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                navbar.classList.add('scrolled');
            } else {
                navbar.classList.remove('scrolled');
            }
        });
    </script>
</body>
</html>


